FROM python:3.11.6-slim

ENV PYTHONUNBUFFERED=1

WORKDIR /app

# Copy requirements and install all dependencies
COPY backend/alembic.ini .
COPY backend/core/requirements.txt .
COPY backend/core/requirements-test.txt requirements-test.txt
COPY backend/community_manager/requirements.txt requirements-community-manager.txt
COPY backend/api/requirements.txt requirements-api.txt
COPY backend/indexer/requirements.txt requirements-indexer.txt

RUN pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install -r requirements-test.txt && \
    pip install -r requirements-community-manager.txt && \
    pip install -r requirements-api.txt && \
    pip install -r requirements-indexer.txt

# Copy package files and source code
COPY backend/setup.py .
COPY backend/setup.cfg .
COPY backend/core ./core
COPY backend/indexer ./indexer
COPY backend/community_manager ./community_manager
COPY backend/api ./api
COPY backend/tests ./tests

# Install packages in editable mode
RUN pip install -e .
